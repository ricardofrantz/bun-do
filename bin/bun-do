#!/usr/bin/env bash
# bun-do service manager
# Usage: bun-do [start|stop|restart|status] [--example]
set -euo pipefail

REPO_DIR="$(cd "$(dirname "$(readlink -f "$0")")/.." && pwd)"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PORT="${TODO_PORT:-8000}"
LOGDIR="$REPO_DIR/logfile"
mkdir -p "$LOGDIR"
PIDFILE="$LOGDIR/todo.pid"
LOGFILE="$LOGDIR/todo.log"
if [[ -n "${TODO_DATA_DIR:-}" ]]; then
  DATA_DIR="${TODO_DATA_DIR/#\~/$HOME}"
else
  DATA_DIR="$REPO_DIR/data"
  SCRIPT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
  for candidate in "$SCRIPT_ROOT/bun-do" "$SCRIPT_ROOT/todo-data" "$SCRIPT_ROOT" "$REPO_DIR"; do
    if [[ -f "$candidate/tasks.json" ]]; then
      DATA_DIR="$candidate"
      break
    fi
    if [[ -f "$candidate/data/tasks.json" ]]; then
      DATA_DIR="$candidate/data"
      break
    fi
  done
fi
TASKS_PATH="$DATA_DIR/tasks.json"
EXAMPLE_TASKS_PATH="$REPO_DIR/data/tasks.example.json"

COMMAND="${1:-start}"
EXAMPLE_MODE=false

for arg in "$@"; do
  case "$arg" in
    --example)
      EXAMPLE_MODE=true
      ;;
    start|stop|restart|status)
      COMMAND="$arg"
      ;;
    -h|--help)
      echo "Usage: bun-do [start|stop|restart|status] [--example]"
      echo "  --example  Load data/tasks.example.json when (re)starting"
      exit 0
      ;;
  esac
done

_pid() {
  [[ -f "$PIDFILE" ]] && cat "$PIDFILE" || echo ""
}

_running() {
  local pid=$(_pid)
  [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null
}

_stop() {
  if _running; then
    local pid=$(_pid)
    kill "$pid" 2>/dev/null
    # Wait up to 3s for clean exit
    for i in {1..12}; do
      kill -0 "$pid" 2>/dev/null || break
      sleep 0.25
    done
    # Force kill if still alive
    kill -0 "$pid" 2>/dev/null && kill -9 "$pid" 2>/dev/null
    rm -f "$PIDFILE"
    echo "[bun-do] stopped (pid $pid)"
  else
    # Clean up stale pidfile or port holder
    rm -f "$PIDFILE"
    if lsof -ti:"$PORT" &>/dev/null; then
      kill "$(lsof -ti:"$PORT")" 2>/dev/null || true
      sleep 0.3
      echo "[bun-do] killed orphan process on port $PORT"
    fi
  fi
}

_start() {
  local tasks_source="$TASKS_PATH"

  if [[ "$EXAMPLE_MODE" == "true" ]]; then
    if [[ -f "$EXAMPLE_TASKS_PATH" ]]; then
      cp "$EXAMPLE_TASKS_PATH" "$TASKS_PATH"
      tasks_source="$EXAMPLE_TASKS_PATH"
      echo "[bun-do] loaded example tasks from $EXAMPLE_TASKS_PATH"
    else
      echo "[bun-do] example file not found at $EXAMPLE_TASKS_PATH" >&2
      return 1
    fi
  fi

  echo "[bun-do] loading tasks from $tasks_source"

  if _running; then
    echo "[bun-do] already running (pid $(_pid)) on http://localhost:$PORT"
    return 0
  fi

  if [[ ! -f "$REPO_DIR/server.ts" ]]; then
    echo "[bun-do] server.ts not found in $REPO_DIR" >&2
    exit 1
  fi

  # Kill anything squatting the port
  if lsof -ti:"$PORT" &>/dev/null; then
    kill "$(lsof -ti:"$PORT")" 2>/dev/null || true
    sleep 0.3
  fi

  cd "$REPO_DIR"
  nohup bun run server.ts --port="$PORT" >> "$LOGFILE" 2>&1 &
  echo $! > "$PIDFILE"

  # Wait for server ready
  for i in {1..20}; do
    curl -s "http://localhost:$PORT/" >/dev/null 2>&1 && break
    sleep 0.25
  done

  if _running; then
    echo "[bun-do] started (pid $(_pid)) on http://localhost:$PORT"
    echo "[bun-do] log: $LOGFILE"
  else
    echo "[bun-do] failed to start â€” check $LOGFILE" >&2
    rm -f "$PIDFILE"
    exit 1
  fi
}

_status() {
  if _running; then
    echo "[bun-do] running (pid $(_pid)) on http://localhost:$PORT"
  else
    rm -f "$PIDFILE"
    echo "[bun-do] not running"
  fi
}

case "$COMMAND" in
  start)   _start ;;
  stop)    _stop ;;
  restart) _stop; _start ;;
  status)  _status ;;
  *)
    echo "Usage: bun-do [start|stop|restart|status] [--example]" >&2
    echo "  --example  Load data/tasks.example.json when (re)starting" >&2
    exit 1
    ;;
esac
